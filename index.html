from flask import Flask, request, jsonify
from flask_cors import CORS
import random
import requests

app = Flask(__name__)
CORS(app, resources={r"/*": {"origins": ["https://kyle4814.github.io", "*"]}}, supports_credentials=True)

# Expanded topic database with diverse subjects
TOPIC_DATABASE = {
    "AI": [
        "ğŸš€ AI is taking over. Hereâ€™s how you can profit before itâ€™s too late!",
        "ğŸ¤– Neural networks now predict consumer behavior with 87% accuracy!",
        "ğŸ”¥ AI-powered automation is making businesses MILLIONS! Are you in?",
        "ğŸ’¡ The ethical implications of AI decision-making in healthcare!",
    ],
    "Business": [
        "ğŸ’° Recession-proof business models thriving right now! Donâ€™t miss out!",
        "ğŸ“ˆ How storytelling creates deep emotional connections with customers!",
        "âš¡ï¸ The cashflow strategies of billion-dollar companies revealed!",
        "ğŸ’¡ Why customer retention beats acquisition every single time!",
    ],
    "Finance": [
        "ğŸš¨ Big investors are shifting money FAST. Hereâ€™s where itâ€™s going!",
        "ğŸ’° Wealth preservation strategies for uncertain economies!",
        "ğŸ”¥ Portfolio diversification secrets top investors donâ€™t want you to know!",
        "ğŸ“‰ What central banks arenâ€™t telling you about inflation!",
    ],
    "Sports": [
        "ğŸ‘‘ Michael Jordanâ€™s mindset hack to DOMINATE competition!",
        "ğŸ† Recovery science is revolutionizing athletic performance!",
        "ğŸ”¥ The secret to mental toughness used by elite athletes!",
        "âš¡ï¸ How sports analytics is changing the game FOREVER!",
    ],
    "Technology": [
        "ğŸš€ Quantum computing is about to disrupt EVERYTHING. Hereâ€™s why!",
        "ğŸ” Biometric authentication tech: The future of security!",
        "ğŸŒ The AI revolution is here! Whatâ€™s next?",
        "âš¡ï¸ How 6G will completely change connectivity as we know it!",
    ],
}

# Function to fetch trending topics from Google Trends API (Placeholder API)
def fetch_google_trends():
    url = "https://trends.google.com/trends/trendingsearches/daily?geo=US"
    try:
        response = requests.get(url, timeout=5)
        if response.status_code == 200:
            trends = response.json().get("default", {}).get("trendingSearchesDays", [])
            return [trend["title"].get("query", "") for trend in trends[:5]]
    except Exception as e:
        print(f"Google Trends fetch error: {e}")
    return []

# Function to fetch data from Reddit API
def fetch_reddit_insights(topic):
    headers = {"User-Agent": "TwitterThreadGenerator/1.0"}
    url = f"https://www.reddit.com/r/{topic}/top.json?limit=5"
    try:
        response = requests.get(url, headers=headers, timeout=5)
        if response.status_code == 200:
            posts = response.json().get("data", {}).get("children", [])
            return [post["data"]["title"] for post in posts][:5]
    except Exception as e:
        print(f"Reddit fetch error: {e}")
    return []

@app.route('/generate_thread', methods=['POST'])
def generate_thread():
    try:
        data = request.json
        topics = [t.strip() for t in data.get("topic", "").split(",")]
        num_threads = min(int(data.get("num_threads", 1)), 10)
        thread_length = min(int(data.get("thread_length", 5)), 8)
        random_mode = data.get("random_mode", False)

        threads = []
        used_insights = set()

        for _ in range(num_threads):
            if random_mode or not topics:
                selected_topic = random.choice(list(TOPIC_DATABASE.keys()))
            else:
                selected_topic = random.choice(topics) if topics else random.choice(list(TOPIC_DATABASE.keys()))

            reddit_insights = fetch_reddit_insights(selected_topic)
            google_trends = fetch_google_trends()
            topic_insights = TOPIC_DATABASE.get(selected_topic, [])

            combined_insights = list(set(reddit_insights + google_trends + topic_insights))
            available_insights = [insight for insight in combined_insights if insight not in used_insights]

            if len(available_insights) < thread_length:
                available_insights = topic_insights

            selected_insights = random.sample(available_insights, min(thread_length, len(available_insights)))
            thread = [f"ğŸ”¥ {selected_topic}: {insight}" for insight in selected_insights]
            used_insights.update(selected_insights)
            threads.append(thread)

        return jsonify({"threads": threads, "status": "success"})

    except Exception as e:
        print(f"Error generating thread: {e}")
        return jsonify({"error": f"Internal Server Error: {str(e)}", "status": "error"}), 500

if __name__ == '__main__':
    print("âœ¨ Insight Generator server is running!")
    app.run(host='0.0.0.0', port=5000, debug=True)
